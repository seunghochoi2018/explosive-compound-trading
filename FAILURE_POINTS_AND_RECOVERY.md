# 시스템 실패 지점 및 자동 복구 매뉴얼

## 발생한 문제들 (과거 이력)

### 1. 59시간 거래 없음 (2025-10-10 ~ 2025-10-12)
**원인:** 통합매니저가 실행되지 않음 + 옛날 코드 실행 중
**결과:** Tier 2 임계값 80%로 모든 신호 차단
**손실:** 기회 비용 (59시간 거래 불가)

### 2. Ollama 연결 실패 반복
**원인:** Ollama 프로세스 죽음
**결과:** LLM이 기본 NEUTRAL 10% 신뢰도 반환 → 거래 불가
**손실:** 거래 기회 상실

### 3. UnicodeEncodeError (Windows cp949)
**원인:** 이모지 문자 사용
**결과:** 시스템 시작 실패
**손실:** 50시간 이상 시스템 다운

---

## 🔴 잠재적 실패 지점 (Critical)

### 실패 지점 #1: 통합매니저 프로세스 죽음
**증상:**
- PID 파일 없음
- 프로세스 목록에 unified_trader_manager.py 없음

**현재 대응:**
✅ Watchdog 30초마다 체크 + 자동 재시작
✅ PID 파일 기반 감지
✅ 프로세스 목록 스캔

**추가 필요:**
⚠️ Watchdog 자체가 죽으면? → **이중 Watchdog 필요**

---

### 실패 지점 #2: Ollama 프로세스 죽음
**증상:**
- ConnectionError: [WinError 10061] 연결 거부
- LLM이 기본 신뢰도 10% 반환

**현재 대응:**
✅ 통합매니저 10초마다 Ollama 헬스 체크
✅ 응답 시간/메모리 모니터링
✅ 자동 재시작 (Ollama + 트레이더)

**추가 필요:**
⚠️ Ollama 모델 로딩 실패 → **모델 사전 로딩 체크**
⚠️ 메모리 부족으로 Ollama 죽음 → **메모리 임계값 9GB 강제**

---

### 실패 지점 #3: 24시간 이상 거래 없음
**증상:**
- eth_dynamic_threshold.json의 last_trade_time이 24시간 이상 지남
- 임계값이 40%까지 떨어졌는데도 거래 없음

**현재 대응:**
✅ 통합매니저 15분마다 거래 기록 체크
✅ 24시간 거래 없음 → CRITICAL 알람 + 텔레그램
✅ 14b LLM 자동 진단 + 코드 분석

**추가 필요:**
⚠️ LLM 진단 후 자동 코드 수정 → **임계값 강제 40%로 리셋**
⚠️ 자동 트레이더 재시작 → **강제 최신 코드 적용**

---

### 실패 지점 #4: ETH/KIS 트레이더 크래시
**증상:**
- 프로세스 poll() == None (종료됨)
- 로그 출력 중단

**현재 대응:**
✅ 통합매니저 10초마다 프로세스 체크
✅ 크래시 감지 → 텔레그램 알림
✅ 자동 재시작 (Ollama 정상이면 트레이더만)

**추가 필요:**
⚠️ 연속 크래시 감지 (1분 내 3회) → **코드 문제 의심, 텔레그램 긴급 알림**

---

### 실패 지점 #5: 잔고 소진 (0 ETH / 0 USD)
**증상:**
- 거래 주문 실패: 잔고 부족
- 피라미딩 계산 결과 0 USD

**현재 대응:**
✅ 피라미딩 로직에서 최소 5 USD 보장
⚠️ 실제 잔고가 5 USD 미만이면?

**추가 필요:**
⚠️ 잔고 < $10 → **즉시 텔레그램 긴급 알림**
⚠️ 잔고 < $5 → **거래 중단 + 사용자 통보**

---

### 실패 지점 #6: API 연결 실패 (Bybit/KIS)
**증상:**
- HTTPError, TimeoutError
- 주문 실패 반복

**현재 대응:**
✅ 각 트레이더에서 3회 재시도
⚠️ 재시도 후에도 실패하면 로그만 남김

**추가 필요:**
⚠️ API 3회 연속 실패 → **텔레그램 알림 + 10분 대기 후 재시도**
⚠️ API 장애 감지 → **다른 거래소 fallback (미래 확장)**

---

### 실패 지점 #7: 텔레그램 알림 실패
**증상:**
- 400 Client Error: Bad Request
- 알림이 안 옴

**현재 대응:**
⚠️ 로그에만 에러 기록
⚠️ 알림 실패해도 계속 진행

**추가 필요:**
⚠️ 텔레그램 실패 → **로컬 파일에 알림 백업 저장**
⚠️ 1시간마다 백업 파일 체크 → **재전송 시도**

---

### 실패 지점 #8: 디스크 용량 부족
**증상:**
- 거래 기록 저장 실패
- 로그 파일 쓰기 실패

**현재 대응:**
⚠️ 감지 안 함

**추가 필요:**
⚠️ 디스크 여유 공간 < 1GB → **긴급 알림 + 오래된 로그 삭제**

---

### 실패 지점 #9: Windows 업데이트 자동 재부팅
**증상:**
- 컴퓨터 재부팅 후 시스템 안 돌아감

**현재 대응:**
✅ Windows 시작프로그램에 Watchdog 등록
✅ Watchdog가 통합매니저 자동 시작

**추가 필요:**
⚠️ 재부팅 감지 → **텔레그램 알림 "시스템 재시작됨"**
⚠️ 부팅 후 5분 내 시스템 정상 작동 확인

---

### 실패 지점 #10: 네트워크 단절
**증상:**
- Websocket 연결 끊김
- API 호출 전부 실패

**현재 대응:**
✅ Websocket 자동 재연결
✅ API 타임아웃 + 재시도

**추가 필요:**
⚠️ 네트워크 5분 이상 단절 → **텔레그램 알림 (4G 백업망 사용)**
⚠️ 네트워크 복구 후 즉시 포지션 동기화

---

## 🟡 자동 복구 우선순위

### P0 (즉시 구현 필요)
1. ✅ **Watchdog 즉시 시작** - 통합매니저 감시
2. ⚠️ **24시간 거래 없음 → 강제 임계값 리셋**
3. ⚠️ **잔고 < $10 긴급 알림**
4. ⚠️ **연속 크래시 감지 (1분 내 3회)**

### P1 (중요)
5. ⚠️ **Ollama 메모리 9GB 강제 제한**
6. ⚠️ **API 연속 실패 → 10분 대기 + 알림**
7. ⚠️ **재부팅 감지 + 알림**

### P2 (개선)
8. ⚠️ **텔레그램 실패 → 로컬 백업**
9. ⚠️ **디스크 용량 모니터링**
10. ⚠️ **네트워크 단절 감지 (5분)**

---

## 📊 현재 시스템 상태 (2025-10-12 13:05)

### ✅ 정상 작동 중
- 통합매니저 PID 12072
- ETH 트레이더 PID 1540 (BUY 포지션)
- KIS 트레이더 PID 25852 (NEUTRAL)
- Ollama 3개 인스턴스 (11434, 11435, 11436)
- GUARDIAN 10초마다 체크
- 24시간 거래 감시 활성화

### ⚠️ 아직 미구현
- Watchdog 실행 안 됨 (다음 재부팅 후 자동 시작)
- 24시간 거래 없음 → 강제 리셋 로직 없음
- 잔고 < $10 긴급 알림 없음
- 연속 크래시 감지 없음

---

## 🛠️ 다음 조치 사항

1. **Watchdog 즉시 시작** (백그라운드)
2. **통합매니저에 강력한 복구 로직 추가:**
   - 24시간 거래 없음 → 임계값 강제 40% 리셋
   - 연속 크래시 감지 → 긴급 알림
   - 잔고 < $10 → 긴급 알림
3. **Git 커밋 + 재시작**

---

생성 시간: 2025-10-12 13:05
최종 업데이트: 2025-10-12 13:05
